# Chimera SSG Deployer - Apache Rewrite Rules
#
# This file works alongside deployer.php to enable atomic deployments
# on shared hosting where the deployer lives in the web root.
#
# SETUP:
# 1. Rename this file to .htaccess
# 2. Upload to your domain's web root (same directory as deployer.php)
#
# HOW IT WORKS:
# - Requests are first checked against the extras/ directory (creator-managed content)
# - If not found in extras/, requests are rewritten to site/ (deployed content)
# - deployer.php is excluded so it remains accessible
# - Apache follows the site/ symlink transparently
# - When a new release deploys, the symlink swaps and traffic shifts instantly
#
# CUSTOM CONTENT:
# Creators can upload files to extras/ via FTP. These persist across deploys.
# Example: extras/about/index.html will be served at /about
# This allows creators to add custom pages without modifying the CMS.

# Allow access to deployer.php from GitHub Actions (Apache 2.4+ syntax)
# Without this, some hosts block requests from cloud provider IPs

# Allow all access (Apache 2.4+ syntax)
Require all granted

RewriteEngine On
RewriteBase /

# --- Custom content in extras/ takes precedence ---
# If the path exists as a file in extras/, serve it from there
RewriteCond %{REQUEST_URI} !^/deployer\.php$
RewriteCond %{REQUEST_URI} !^/site/
RewriteCond %{REQUEST_URI} !^/extras/
RewriteCond %{REQUEST_URI} !^/releases/
RewriteCond %{DOCUMENT_ROOT}/extras/$1 -f
RewriteRule ^(.*)$ extras/$1 [L]

# If the path exists as a directory in extras/ with an index.html, serve it from there
RewriteCond %{REQUEST_URI} !^/deployer\.php$
RewriteCond %{REQUEST_URI} !^/site/
RewriteCond %{REQUEST_URI} !^/extras/
RewriteCond %{REQUEST_URI} !^/releases/
RewriteCond %{DOCUMENT_ROOT}/extras/$1/index.html -f
RewriteRule ^(.*)$ extras/$1 [L]

# --- Fall back to deployed site ---
RewriteCond %{REQUEST_URI} !^/deployer\.php$
RewriteCond %{REQUEST_URI} !^/site/
RewriteCond %{REQUEST_URI} !^/extras/
RewriteCond %{REQUEST_URI} !^/releases/
RewriteCond %{DOCUMENT_ROOT}/site -d
RewriteRule ^(.*)$ site/$1 [L]
